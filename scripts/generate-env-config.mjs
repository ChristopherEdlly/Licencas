#!/usr/bin/env node
/**
 * Generate env.config.js from .env so the browser can access runtime settings.
 * The generated file is ignored by git. Never commit sensitive credentials.
 */

import { promises as fs } from 'fs';
import path from 'path';

const ROOT = path.resolve(new URL('..', import.meta.url).pathname);
const ENV_PATH = path.join(ROOT, '.env');
const OUTPUT_PATH = path.join(ROOT, 'env.config.js');

function parseEnv(content) {
  const result = {};
  content.split(/\r?\n/).forEach((line) => {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#')) return;
    const eqIndex = trimmed.indexOf('=');
    if (eqIndex === -1) return;
    const key = trimmed.slice(0, eqIndex).trim();
    const value = trimmed.slice(eqIndex + 1).trim();
    if (key) {
      result[key] = value;
    }
  });
  return result;
}

try {
  const raw = await fs.readFile(ENV_PATH, 'utf8');
  const env = parseEnv(raw);

  const {
    AZURE_CLIENT_ID = '',
    AZURE_TENANT_ID = '',
    AZURE_REDIRECT_URI = '',
    AZURE_AUTHORITY = '',
    AZURE_SCOPES = ''
  } = env;

  const config = {
    AZURE_CLIENT_ID,
    AZURE_TENANT_ID,
    AZURE_REDIRECT_URI,
    AZURE_AUTHORITY,
    AZURE_SCOPES: AZURE_SCOPES.split(',').map((scope) => scope.trim()).filter(Boolean)
  };

  if (env.AZURE_CLIENT_SECRET) {
    console.warn('AZURE_CLIENT_SECRET detectado no .env, mas não é seguro expor segredos em apps client-side. Ignorando esse campo.');
  }

  const banner = `/**\n * Auto-generated by scripts/generate-env-config.mjs on ${new Date().toISOString()}\n * Do NOT commit this file.\n */\n`;

  const payload = `${banner}window.__ENV__ = window.__ENV__ || {};\nObject.assign(window.__ENV__, ${JSON.stringify(config, null, 2)});\n`;

  await fs.writeFile(OUTPUT_PATH, payload, 'utf8');
  console.log(`Generated ${path.relative(ROOT, OUTPUT_PATH)} successfully.`);
} catch (error) {
  console.error('Failed to generate env.config.js:', error.message);
  process.exitCode = 1;
}
