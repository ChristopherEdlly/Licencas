<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testes E2E - Aplica√ß√£o de Licen√ßas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }

        #test-results {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }

        .test-suite {
            margin-bottom: 30px;
            border-left: 4px solid #007bff;
            padding-left: 15px;
        }

        .test-suite h2 {
            color: #007bff;
            margin: 10px 0;
            font-size: 1.2rem;
        }

        .test-case {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-case.pass {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .test-case.fail {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .test-case.skip {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .test-icon {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .test-icon.pass { color: #28a745; }
        .test-icon.fail { color: #dc3545; }
        .test-icon.skip { color: #ffc107; }

        .error-message {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #dc3545;
            white-space: pre-wrap;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .summary-card h3 {
            margin: 0;
            font-size: 2rem;
            color: #007bff;
        }

        .summary-card p {
            margin: 5px 0 0 0;
            color: #666;
        }

        .summary-card.pass h3 { color: #28a745; }
        .summary-card.fail h3 { color: #dc3545; }
        .summary-card.skip h3 { color: #ffc107; }

        #run-tests-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        #run-tests-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        #run-tests-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>üß™ Testes End-to-End (E2E) - Dashboard de Licen√ßas</h1>

    <button id="run-tests-btn" onclick="runAllTests()">‚ñ∂Ô∏è Executar Todos os Testes</button>

    <div class="progress-bar" style="display: none;" id="progress-bar">
        <div class="progress-fill" id="progress-fill">0%</div>
    </div>

    <div class="summary" id="summary" style="display: none;">
        <div class="summary-card">
            <h3 id="total-tests">0</h3>
            <p>Total de Testes</p>
        </div>
        <div class="summary-card pass">
            <h3 id="passed-tests">0</h3>
            <p>Aprovados ‚úÖ</p>
        </div>
        <div class="summary-card fail">
            <h3 id="failed-tests">0</h3>
            <p>Reprovados ‚ùå</p>
        </div>
        <div class="summary-card skip">
            <h3 id="skipped-tests">0</h3>
            <p>Pulados ‚ö†Ô∏è</p>
        </div>
    </div>

    <div id="test-results"></div>

    <!-- Carregar todas as depend√™ncias necess√°rias -->
    <script src="../../Js/5-app/EventBus.js"></script>
    <script src="../../Js/5-app/Router.js"></script>

    <!-- Core -->
    <script src="../../Js/1-core/utilities/DateUtils.js"></script>
    <script src="../../Js/1-core/utilities/FormatUtils.js"></script>
    <script src="../../Js/1-core/utilities/ValidationUtils.js"></script>
    <script src="../../Js/1-core/utilities/MathUtils.js"></script>

    <!-- Business Logic -->
    <script src="../../Js/1-core/business-logic/AposentadoriaAnalyzer.js"></script>
    <script src="../../Js/1-core/business-logic/LicencaCalculator.js"></script>

    <!-- Data Flow -->
    <script src="../../Js/1-core/data-flow/DataParser.js"></script>
    <script src="../../Js/1-core/data-flow/DataTransformer.js"></script>

    <!-- Services -->
    <script src="../../Js/2-services/FileService.js"></script>
    <script src="../../Js/2-services/CacheService.js"></script>

    <!-- Managers -->
    <script src="../../Js/3-managers/state/DataStateManager.js"></script>
    <script src="../../Js/3-managers/ui/SidebarManager.js"></script>
    <script src="../../Js/3-managers/ui/TableManager.js"></script>
    <script src="../../Js/3-managers/ui/ChartManager.js"></script>
    <script src="../../Js/3-managers/features/CalendarManager.js"></script>
    <script src="../../Js/3-managers/features/TimelineManager.js"></script>

    <!-- Pages -->
    <script src="../../Js/4-pages/HomePage.js"></script>
    <script src="../../Js/4-pages/CalendarPage.js"></script>
    <script src="../../Js/4-pages/TimelinePage.js"></script>
    <script src="../../Js/4-pages/ReportsPage.js"></script>
    <script src="../../Js/4-pages/SettingsPage.js"></script>
    <script src="../../Js/4-pages/TipsPage.js"></script>

    <!-- App -->
    <script src="../../Js/5-app/App.js"></script>

    <!-- Framework de Teste Simples -->
    <script>
        // Mini framework de testes
        const testFramework = {
            suites: [],
            currentSuite: null,
            stats: { total: 0, passed: 0, failed: 0, skipped: 0 },

            describe(name, fn) {
                const suite = { name, tests: [] };
                this.suites.push(suite);
                this.currentSuite = suite;
                fn();
                this.currentSuite = null;
            },

            test(name, fn) {
                if (!this.currentSuite) {
                    console.error('test() deve ser chamado dentro de describe()');
                    return;
                }
                this.currentSuite.tests.push({ name, fn });
            },

            async runAll() {
                this.stats = { total: 0, passed: 0, failed: 0, skipped: 0 };
                const resultsDiv = document.getElementById('test-results');
                resultsDiv.innerHTML = '';

                const progressBar = document.getElementById('progress-bar');
                const progressFill = document.getElementById('progress-fill');
                progressBar.style.display = 'block';

                let testsRun = 0;
                const totalTests = this.suites.reduce((sum, suite) => sum + suite.tests.length, 0);

                for (const suite of this.suites) {
                    const suiteDiv = document.createElement('div');
                    suiteDiv.className = 'test-suite';
                    suiteDiv.innerHTML = `<h2>${suite.name}</h2>`;

                    for (const test of suite.tests) {
                        this.stats.total++;
                        testsRun++;

                        const testDiv = document.createElement('div');
                        testDiv.className = 'test-case';

                        try {
                            await test.fn();
                            this.stats.passed++;
                            testDiv.classList.add('pass');
                            testDiv.innerHTML = `
                                <span class="test-icon pass">‚úÖ</span>
                                <span>${test.name}</span>
                            `;
                        } catch (error) {
                            this.stats.failed++;
                            testDiv.classList.add('fail');
                            testDiv.innerHTML = `
                                <span class="test-icon fail">‚ùå</span>
                                <span>${test.name}</span>
                            `;

                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'error-message';
                            errorDiv.textContent = error.stack || error.message;
                            testDiv.appendChild(errorDiv);
                        }

                        suiteDiv.appendChild(testDiv);

                        // Atualizar progress bar
                        const progress = (testsRun / totalTests) * 100;
                        progressFill.style.width = progress + '%';
                        progressFill.textContent = Math.round(progress) + '%';
                    }

                    resultsDiv.appendChild(suiteDiv);
                }

                progressBar.style.display = 'none';
                this.displaySummary();
            },

            displaySummary() {
                document.getElementById('summary').style.display = 'grid';
                document.getElementById('total-tests').textContent = this.stats.total;
                document.getElementById('passed-tests').textContent = this.stats.passed;
                document.getElementById('failed-tests').textContent = this.stats.failed;
                document.getElementById('skipped-tests').textContent = this.stats.skipped;
            },

            expect(actual) {
                return {
                    toBe(expected) {
                        if (actual !== expected) {
                            throw new Error(`Esperado ${expected}, mas recebeu ${actual}`);
                        }
                    },
                    toBeDefined() {
                        if (actual === undefined) {
                            throw new Error('Esperado valor definido, mas recebeu undefined');
                        }
                    },
                    toContain(expected) {
                        if (!actual || !actual.includes(expected)) {
                            throw new Error(`Esperado que ${actual} contenha ${expected}`);
                        }
                    },
                    toBeGreaterThan(expected) {
                        if (actual <= expected) {
                            throw new Error(`Esperado que ${actual} seja maior que ${expected}`);
                        }
                    },
                    toBeLessThan(expected) {
                        if (actual >= expected) {
                            throw new Error(`Esperado que ${actual} seja menor que ${expected}`);
                        }
                    }
                };
            }
        };

        // Expor globalmente
        window.describe = testFramework.describe.bind(testFramework);
        window.test = testFramework.test.bind(testFramework);
        window.expect = testFramework.expect.bind(testFramework);
        window.beforeEach = () => {}; // Mock
        window.afterEach = () => {}; // Mock

        async function runAllTests() {
            const btn = document.getElementById('run-tests-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Executando testes...';

            await testFramework.runAll();

            btn.disabled = false;
            btn.textContent = 'üîÑ Executar Novamente';
        }
    </script>

    <!-- Carregar teste E2E -->
    <script src="./app.test.e2e.js"></script>
</body>
</html>
